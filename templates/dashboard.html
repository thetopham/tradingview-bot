<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trade Feed Dashboard</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --accent: #22d3ee;
            --accent-2: #a855f7;
            --danger: #f43f5e;
            --success: #22c55e;
        }
        body {
            margin: 0;
            font-family: "Inter", system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        header {
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        h1 {
            margin: 0;
            font-size: 24px;
            letter-spacing: 0.5px;
        }
        .badges {
            display: flex;
            gap: 12px;
        }
        .badge {
            background: var(--panel);
            padding: 8px 12px;
            border-radius: 12px;
            color: var(--muted);
            font-size: 13px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }
        .container {
            padding: 0 24px 24px;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .card {
            background: var(--panel);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .card h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        .card .value {
            font-size: 28px;
            font-weight: 700;
        }
        .card .subtext {
            font-size: 13px;
            color: var(--muted);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--panel);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }
        thead {
            background: rgba(255, 255, 255, 0.03);
        }
        th, td {
            padding: 12px;
            text-align: left;
            font-size: 14px;
        }
        th {
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.6px;
            font-size: 12px;
        }
        tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }
        .pill {
            padding: 4px 8px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 12px;
            display: inline-block;
        }
        .pill.buy { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .pill.sell { background: rgba(244, 63, 94, 0.15); color: var(--danger); }
        .pill.hold { background: rgba(148, 163, 184, 0.15); color: var(--muted); }
        .pill.flat { background: rgba(34, 211, 238, 0.15); color: var(--accent); }
        .muted { color: var(--muted); }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }
        .pnl-positive { color: var(--success); font-weight: 700; }
        .pnl-negative { color: var(--danger); font-weight: 700; }
        .screenshot {
            max-width: 160px;
        }
        .timestamp { white-space: nowrap; }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>AI Trade Feed</h1>
            <div class="badges">
                <div class="badge">Live Supabase feed</div>
                <div class="badge" id="last-updated">Updated now</div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="metrics" id="metrics"></div>

        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>Account</th>
                        <th>Symbol</th>
                        <th>Signal</th>
                        <th>Size</th>
                        <th>PnL</th>
                        <th>AI ID</th>
                        <th>Reason</th>
                        <th>Screenshot</th>
                    </tr>
                </thead>
                <tbody id="feed-body">
                    <tr><td colspan="10" class="muted">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const feedBody = document.getElementById('feed-body');
        const metricsContainer = document.getElementById('metrics');
        const lastUpdated = document.getElementById('last-updated');

        function formatPnL(value) {
            const num = Number(value);
            if (Number.isNaN(num)) return '<span class="muted">n/a</span>';
            const cls = num >= 0 ? 'pnl-positive' : 'pnl-negative';
            return `<span class="${cls}">${num.toFixed(2)}</span>`;
        }

        function formatSignal(signal) {
            const val = (signal || '').toString().toLowerCase();
            return `<span class="pill ${val}">${signal || 'n/a'}</span>`;
        }

        function renderMetrics(metrics) {
            metricsContainer.innerHTML = '';
            const items = [
                { label: 'Open Position PnL', value: metrics.open_position_pnl, color: 'var(--accent)' },
                { label: 'Win %', value: metrics.win_rate + '%', color: 'var(--success)' },
                { label: 'Daily PnL', value: metrics.daily_pnl, color: 'var(--accent-2)' },
                { label: 'Total Trades', value: metrics.total_trades, color: 'var(--text)' },
            ];

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${item.label}</h3>
                    <div class="value" style="color:${item.color}">${item.value}</div>
                    <div class="subtext">Updated just now</div>
                `;
                metricsContainer.appendChild(card);
            });
        }

        function renderFeed(rows) {
            if (!rows.length) {
                feedBody.innerHTML = '<tr><td colspan="10" class="muted">No trades found</td></tr>';
                return;
            }

            feedBody.innerHTML = rows.map(row => {
                const screenshot = row.screenshot_url || row.chart_url || row.screenshot;
                const aiId = row.ai_decision_id || row.ai_id || '—';
                const reason = row.reason || '—';

                return `
                    <tr>
                        <td class="timestamp">${row.entry || row.entry_time || '—'}</td>
                        <td class="timestamp">${row.exit || row.exit_time || '—'}</td>
                        <td>${row.account || '—'}</td>
                        <td>${row.symbol || '—'}</td>
                        <td>${formatSignal(row.signal)}</td>
                        <td>${row.size ?? '—'}</td>
                        <td>${formatPnL(row.pnl)}</td>
                        <td>${aiId}</td>
                        <td>${reason}</td>
                        <td>
                            ${screenshot ? `<a href="${screenshot}" target="_blank">View</a>` : '<span class="muted">—</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function refresh() {
            try {
                const res = await fetch('/api/dashboard/feed');
                const data = await res.json();
                renderFeed(data.feed || []);
                renderMetrics(data.metrics || {});
                const now = new Date();
                lastUpdated.textContent = `Updated ${now.toLocaleTimeString()}`;
            } catch (err) {
                console.error(err);
                feedBody.innerHTML = '<tr><td colspan="10" class="muted">Failed to load feed</td></tr>';
            }
        }

        refresh();
        setInterval(refresh, 15000);
    </script>
</body>
</html>
