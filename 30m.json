{
  "name": "30m",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "694cc668-54e1-4b18-94e7-51a381764295",
              "name": "response",
              "value": "={{ $json.url }}",
              "type": "string"
            }
          ]
        },
        "options": {
          "includeBinary": true
        }
      },
      "id": "baf99582-5cf5-4167-820a-d1afb96c2427",
      "name": "Set 'response' value",
      "type": "n8n-nodes-base.set",
      "position": [
        1160,
        60
      ],
      "typeVersion": 3.3
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chart-img.com/v2/tradingview/layout-chart/storage/1LucwVmQ",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "content-type",
              "value": "application/json"
            },
            {
              "name": "tradingview-session-id",
              "value": "3mj0z4rbt80q53ph30p82i1pu9k91vh7"
            },
            {
              "name": "tradingview-session-id-sign",
              "value": "v3:hv1B6jvs2MSGaLCIPXxIsuPkoR73HOmY2ajBU7KNvBE="
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "format",
              "value": "jpeg"
            },
            {
              "name": "interval",
              "value": "30m"
            },
            {
              "name": "width",
              "value": "1920"
            },
            {
              "name": "height",
              "value": "1080"
            }
          ]
        },
        "options": {}
      },
      "id": "72706694-5c3a-4625-a507-0bb81dc64294",
      "name": "Tradingview Chart",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        600,
        60
      ],
      "typeVersion": 4.2,
      "retryOnFail": true,
      "credentials": {
        "httpHeaderAuth": {
          "id": "ZleHrixI7F5TA8Yb",
          "name": "chart-img"
        }
      }
    },
    {
      "parameters": {
        "content": "## Start here: Step-by Step Youtube Tutorial :star:\n\n[![Technical Analyst AI Agent using LLM Vision](https://img.youtube.com/vi/yjBHheCB6Ek/sddefault.jpg)](https://youtu.be/yjBHheCB6Ek)\n",
        "height": 550,
        "width": 507,
        "color": 7
      },
      "id": "340bdf01-e805-49b4-80f6-b005e0bff94c",
      "name": "Sticky Note5",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -640,
        40
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        860,
        60
      ],
      "id": "27a2891c-bc30-4013-8f30-d79977dab96f",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "5m",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        40,
        80
      ],
      "id": "67b62b25-e3ed-4c81-bc32-5d49ea52d46b",
      "name": "Webhook",
      "webhookId": "5c793395-f218-4a49-a620-51d297f2dbfb"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        60,
        280
      ],
      "id": "d6807833-784d-4fa8-ab30-a179e8cdc457",
      "name": "When clicking ‘Test workflow’"
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        40,
        -120
      ],
      "id": "0d1f6a39-58eb-4814-83dd-88e695a51548",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are an expert day trading analyst for the Micro E-mini S&P 500 (MES).\n\nAnalyze the attached chart image for the 30m timeframe.\nFirst, determine the market regime, then generate your trade signal and context using only information visible in the chart. ALWAYS consider higher timeframe trends when provided.\n\nStep 1: Market Regime & Trend Assessment\n- Classify the current market regime:\n  - strong_trend: Price making clear higher highs/lows (uptrend) or lower highs/lows (downtrend).\n  - weak_trend: Trend is losing momentum, pullbacks deeper, more divergences.\n  - range: Price bouncing between defined support and resistance.\n  - breakout: Sudden expansion beyond prior range or support/resistance.\n- Identify trend direction: up, down, or sideways.\n- If you are given higher timeframe context (e.g., from 1h, 4h), factor it in and avoid fading strong higher timeframe trends.\n\nStep 2: Signal Generation (Regime-Specific Logic)\n- If strong trend:\n  - Signal = trade WITH the trend on pullbacks to support/resistance/moving average.\n  - Ignore minor divergences unless confirmed by multiple timeframes.\n  - Only reverse on major exhaustion signals (e.g., strong divergence + momentum shift + major S/R rejection).\n- If weak/mature trend:\n  - Watch divergences closely.\n  - Consider counter-trend scalps at extremes.\n  - Tighten stops on trend trades.\n- If range/chop:\n  - Signal = fade extremes (buy support, sell resistance).\n  - Divergences are HIGH VALUE here.\n  - HOLD if price is in the middle of the range.\n- If breakout:\n  - Only trade in breakout direction after confirmation.\n  - Avoid fading unless breakout fails and price returns inside range.\n\nStep 3: Extract Visible Data (Be Concise, Use Nulls if Not Shown)\n- Up to 3 major support levels (lowest to highest)\n- Up to 3 major resistance levels (lowest to highest)\n- Entry price, stop loss, up to 3 take profits, all based on visible structure (set null if not visible)\n- Current price, recent high, recent low, percent of current price through visible range (0–100)\n- Momentum: accelerating, steady, decelerating\n- Volatility: high, medium, low (if visible)\n- Indicators (from chart):\n  - ATR Crayon: bullish/bearish/neutral/not_shown\n  - FSVZO: above_zero/below_zero/neutral/not_shown\n  - Phobos: positive_momentum/negative_momentum/neutral/not_shown\n  - Fisher: bullish_divergence/bearish_divergence/neutral/not_shown\n- Candle pattern: hammer, doji, engulfing, none (or not_shown)\n- Volume trend: increasing, decreasing, flat, not_shown\n\nStep 4: Provide Context & Reason\n- Brief price action summary (1-2 sentences)\n- Clearly explain your signal in context of regime, trend, indicators, and price action\n- List any major risk factors (e.g., \"Breakout is extended and at resistance; reversal risk if rejected.\")\n- Always include the chart URL\n\nFormatting\n- Use only information from the visible chart image and provided context.\n- If a data field is not visible, use null or \"not_shown\" as appropriate.\n- Respond with valid JSON only—no extra commentary, no markdown.\n\nJSON Output:\n{\n  \"timeframe\": \"30m\",\n  \"market_regime\": \"strong_trend|weak_trend|range|breakout\",\n  \"trend_direction\": \"up|down|sideways\",\n  \"trend_strength\": \"strong|moderate|weak|exhausted\",\n  \"signal\": \"BUY|SELL|HOLD\",\n  \"signal_type\": \"trend_continuation|reversal|range_fade|breakout\",\n  \"signal_confidence\": \"high|medium|low\",\n  \"entrylimit\": <float|null>,\n  \"tp1\": <float|null>,\n  \"tp2\": <float|null>,\n  \"tp3\": <float|null>,\n  \"sl\": <float|null>,\n  \"support\": [<float|null>, <float|null>, <float|null>],\n  \"resistance\": [<float|null>, <float|null>, <float|null>],\n  \"trade_location\": \"pullback|breakout|extreme|middle\",\n  \"current_price\": <float|null>,\n  \"recent_high\": <float|null>,\n  \"recent_low\": <float|null>,\n  \"percent_of_range\": <float 0-100|null>,\n  \"momentum\": \"accelerating|steady|decelerating|not_shown\",\n  \"momentum_alignment\": \"with_trend|against_trend|neutral|not_shown\",\n  \"volatility\": \"high|medium|low|not_shown\",\n  \"range_size\": <float|null>,\n  \"indicators\": {\n    \"ATR_crayon\": \"bullish|bearish|neutral|not_shown\",\n    \"FSVZO\": \"above_zero|below_zero|neutral|not_shown\",\n    \"Phobos\": \"positive_momentum|negative_momentum|neutral|not_shown\",\n    \"Fisher\": \"bullish_divergence|bearish_divergence|neutral|not_shown\"\n  },\n  \"candle_pattern\": \"hammer|doji|engulfing|none|not_shown\",\n  \"volume_trend\": \"increasing|decreasing|flat|not_shown\",\n  \"price_action_summary\": \"<1-2 sentences, price action recap>\",\n  \"setup_detected\": \"<pattern|none|not_shown>\",\n  \"reason\": \"<concise regime-driven explanation of your signal and trade idea>\",\n  \"risk_factors\": [\"<what could invalidate this signal>\"],\n  \"chart_time\": \"{{ $now }}\",\n  \"url\": \"{{ $json.response }}\"\n}\n",
        "messages": {
          "messageValues": [
            {
              "type": "HumanMessagePromptTemplate",
              "messageType": "imageBinary"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        1400,
        60
      ],
      "id": "d4dbec48-6f4c-46a4-b281-9b3a814aeebd",
      "name": "Basic LLM Chain"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "chatgpt-4o-latest"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1400,
        280
      ],
      "id": "0c4c0625-bb7c-4229-a05e-3b1a0023cbf4",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "hOvrgCZvpztkucKb",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.text }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.2,
      "position": [
        2140,
        -80
      ],
      "id": "eaa54a5c-fda1-4804-b71d-5069b0bb0ad5",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "tableId": "chart_analysis",
        "dataToSend": "autoMapInputData"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2140,
        160
      ],
      "id": "7dcd0802-16bc-463d-b1bb-c69c6cd93ee2",
      "name": "Supabase2",
      "credentials": {
        "supabaseApi": {
          "id": "id8sHbOkjIgqTd0J",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "let raw = $input.first().json.text;\n\n// Strip code block markers, leading/trailing quotes, and whitespace\nraw = raw.trim()\n    .replace(/^```json\\s*/i, '')\n    .replace(/^```\\s*/i, '')\n    .replace(/```$/i, '')\n    .replace(/^'|'$/g, '');\n\nreturn [ JSON.parse(raw) ];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1820,
        60
      ],
      "id": "6e91668e-4c6e-4406-a54b-a866bf4be128",
      "name": "Code"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "latest_chart_analysis",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "symbol",
              "condition": "eq",
              "keyValue": "MES"
            },
            {
              "keyName": "timeframe",
              "condition": "eq",
              "keyValue": "={{ $json.timeframe }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "snapshot",
              "fieldValue": "={{ $('Basic LLM Chain').item.json.text }}"
            },
            {
              "fieldId": "timestamp",
              "fieldValue": "={{ $json.chart_time }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2140,
        360
      ],
      "id": "822151b1-b248-48df-9028-34a3ef9abf2b",
      "name": "Supabase1",
      "credentials": {
        "supabaseApi": {
          "id": "id8sHbOkjIgqTd0J",
          "name": "Supabase account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Tradingview Chart": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Set 'response' value",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Tradingview Chart",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set 'response' value": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Test workflow’": {
      "main": [
        [
          {
            "node": "Tradingview Chart",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Tradingview Chart",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Supabase2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Supabase1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "61a450bc-ad7a-4978-84f8-3fccc00027c7",
  "meta": {
    "instanceId": "9783a33f8d5600da0ff08d35d1dc9051c104e0a37fceb74a2ffe1557dcda02bc"
  },
  "id": "KWlHcm2igwb0181Y",
  "tags": []
}
